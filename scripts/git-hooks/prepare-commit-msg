#!/bin/bash
# Git hook to prompt for version increment at commit time

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only prompt for regular commits (not merges, amends, etc.)
if [ "$COMMIT_SOURCE" != "" ] && [ "$COMMIT_SOURCE" != "message" ]; then
  exit 0
fi

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
CONFIG_FILE="$REPO_ROOT/lister/config/default.json"
BUMP_SCRIPT="$REPO_ROOT/scripts/bump_version.sh"

# Check if version file is already staged or committed in this commit
if ! git diff --cached --quiet -- "$CONFIG_FILE" 2>/dev/null; then
  # Version file already staged, skip prompt
  exit 0
fi

# Check if we're in a merge or rebase
if [ -f "$(git rev-parse --git-dir)/MERGE_HEAD" ] || [ -f "$(git rev-parse --git-dir)/rebase-merge" ]; then
  exit 0
fi

# Version file not changed, prompt for increment
CURRENT_VERSION=$(grep -o '"version": "[^"]*"' "$CONFIG_FILE" | cut -d'"' -f4)
  
  echo ""
  echo "Current version: $CURRENT_VERSION"
  echo "Increment version for this commit?"
  echo "  [p]atch (default) - bug fixes, small changes"
  echo "  [m]inor - new features, significant updates"
  echo "  [M]ajor - breaking changes"
  echo "  [n]o - skip version increment"
  echo -n "Choice [p/m/M/n]: "
  
  read -r choice
  
  case $choice in
    m|minor)
      NEW_VERSION=$("$BUMP_SCRIPT" minor)
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (minor)"
      ;;
    M|major)
      NEW_VERSION=$("$BUMP_SCRIPT" major)
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (major)"
      ;;
    n|no)
      echo "Skipping version increment"
      ;;
    "")
      # Default to patch if empty (just Enter)
      NEW_VERSION=$("$BUMP_SCRIPT" patch)
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (patch)"
      ;;
    p|patch|*)
      NEW_VERSION=$("$BUMP_SCRIPT" patch)
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (patch)"
      ;;
  esac
  echo ""

exit 0
