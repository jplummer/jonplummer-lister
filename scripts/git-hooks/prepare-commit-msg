#!/bin/bash
# Git hook to prompt for version increment at commit time

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only prompt for regular commits (not merges, amends, etc.)
if [ "$COMMIT_SOURCE" != "" ] && [ "$COMMIT_SOURCE" != "message" ]; then
  exit 0
fi

# Get the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
CONFIG_FILE="$REPO_ROOT/lister/config/default.json"
BUMP_SCRIPT="$REPO_ROOT/scripts/bump_version.sh"
CHANGELOG_SCRIPT="$REPO_ROOT/scripts/update_changelog.sh"
CHANGELOG_FILE="$REPO_ROOT/docs/CHANGELOG.md"

# Check if version file is already staged or committed in this commit
if ! git diff --cached --quiet -- "$CONFIG_FILE" 2>/dev/null; then
  # Version file already staged, skip prompt
  exit 0
fi

# Check if we're in a merge or rebase
if [ -f "$(git rev-parse --git-dir)/MERGE_HEAD" ] || [ -f "$(git rev-parse --git-dir)/rebase-merge" ]; then
  exit 0
fi

# Version file not changed, prompt for increment
CURRENT_VERSION=$(grep -o '"version": "[^"]*"' "$CONFIG_FILE" | cut -d'"' -f4)
  
  echo ""
  echo "Current version: $CURRENT_VERSION"
  echo "Increment version for this commit?"
  echo "  [p]atch (default) - bug fixes, small changes"
  echo "  [m]inor - new features, significant updates"
  echo "  [M]ajor - breaking changes"
  echo "  [n]o - skip version increment"
  echo -n "Choice [p/m/M/n]: "
  
  read -r choice
  
  INCREMENT_TYPE=""
  case $choice in
    m|minor)
      NEW_VERSION=$("$BUMP_SCRIPT" minor)
      INCREMENT_TYPE="minor"
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (minor)"
      ;;
    M|major)
      NEW_VERSION=$("$BUMP_SCRIPT" major)
      INCREMENT_TYPE="major"
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (major)"
      ;;
    n|no)
      echo "Skipping version increment"
      exit 0
      ;;
    "")
      # Default to patch if empty (just Enter)
      NEW_VERSION=$("$BUMP_SCRIPT" patch)
      INCREMENT_TYPE="patch"
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (patch)"
      ;;
    p|patch|*)
      NEW_VERSION=$("$BUMP_SCRIPT" patch)
      INCREMENT_TYPE="patch"
      git add "$CONFIG_FILE"
      echo "✓ Version bumped to $NEW_VERSION (patch)"
      ;;
  esac
  
  # Prompt for changelog update
  if [ -n "$NEW_VERSION" ]; then
    echo ""
    echo "Update CHANGELOG.md for version $NEW_VERSION?"
    echo "  [y]es (default) - add changelog entry"
    echo "  [n]o - skip changelog update"
    echo -n "Choice [y/n]: "
    read -r changelog_choice
    
    if [ "$changelog_choice" != "n" ] && [ "$changelog_choice" != "no" ]; then
      echo ""
      echo "Enter changelog entries (one per line, empty line to finish):"
      echo "Enter entries without the '- ' prefix (it will be added automatically)"
      echo "Examples:"
      echo "  Fixed bug in directory traversal"
      echo "  Added new file type support"
      echo ""
      
      CHANGELOG_ENTRIES=()
      while IFS= read -r line; do
        if [ -z "$line" ]; then
          break
        fi
        # Remove leading "- " if user included it
        line=$(echo "$line" | sed 's/^-\s*//')
        CHANGELOG_ENTRIES+=("$line")
      done
      
      if [ ${#CHANGELOG_ENTRIES[@]} -gt 0 ]; then
        "$CHANGELOG_SCRIPT" "$NEW_VERSION" "$INCREMENT_TYPE" "${CHANGELOG_ENTRIES[@]}"
        git add "$CHANGELOG_FILE"
        echo "✓ Changelog updated"
      else
        echo "No entries provided, skipping changelog update"
      fi
    fi
  fi
  echo ""

exit 0
